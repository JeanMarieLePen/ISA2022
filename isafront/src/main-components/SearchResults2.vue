<template>
    <div style="width:100%">
        <table>
            <tr>
                <td>
                    <button class="filter-button" style="margin-left:10px" id="buttonSort" @click="tempSort('nazivEntiteta')">Naziv 
                        <img v-if='currentSortDir == "asc" && currentSort== "nazivEntiteta"' src='../assets/up-arrow1.1.png'>
                        <img v-if='currentSortDir == "desc" && currentSort== "nazivEntiteta" ' src='../assets/down-arrow1.1.png'>
                    </button>
                </td>
                <td>
                    <button class="filter-button" id="buttonSort" @click="tempSort('lokacijaEntiteta')">Lokacija 
                        <img v-if='currentSortDir == "asc" && currentSort== "lokacijaEntiteta"' src='../assets/up-arrow1.1.png'>
                        <img v-if='currentSortDir == "desc" && currentSort== "lokacijaEntiteta" ' src='../assets/down-arrow1.1.png'>
                    </button>
                </td>
                <td>
                    <button class="filter-button" id="buttonSort"  @click="tempSort('ocenaEntiteta')">Ocena
                        <img v-if='currentSortDir == "asc" && currentSort== "ocenaEntiteta"' src='../assets/up-arrow1.1.png'>
                        <img v-if='currentSortDir == "desc" && currentSort== "ocenaEntiteta" ' src='../assets/down-arrow1.1.png'>
                    </button>
                </td>
                <td>
                    <button class="filter-button" id="buttonSort"  @click="tempSort('razdaljinaEntiteta')">Razdaljina
                        <img v-if='currentSortDir == "asc" && currentSort== "razdaljinaEntiteta"' src='../assets/up-arrow1.1.png'>
                        <img v-if='currentSortDir == "desc" && currentSort== "razdaljinaEntiteta" ' src='../assets/down-arrow1.1.png'>
                    </button>
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <input style="margin-left:10px; width:100%" v-model="inputFilter" placeholder="Filter rezultata pretrage...">
                </td>
            </tr>
            <tr style="height:30px;"/>

        </table>
        <section style="margin-left: 10px; margin-bottom:100px;">
            <div>
            <!-- if we are 3 cards wide start a new row -->
                <div class="row">
                    <div class="col-md-4" v-bind:key="index" v-for="(tempHospital, index) in sortEntities.slice(0,15)">
                        <div style="width:90%;height:300px; margin-bottom:100px;" class="card">
                            <!-- <img class="card-img-top" :src="product.thumbnailUrl" alt="card image collar"> -->
                            <div class="card-body">
                                <h5 class="card-title">Ustanova {{tempHospital.naziv}}</h5>
                                <p class="card-text">Ustanova {{tempHospital.naziv}}</p>
                                <p class="card-text">{{tempHospital.adresa}}</p>
                                <p class="card-text">Udaljenost: {{tempHospital.razdaljina}}</p>
                                <starrating style="margin-bottom:10px" read-only v-model="tempHospital.ocena" :star-size="20"/>
                                
                            </div>
                            <div style="margin-bottom:30px;margin-top:px;" class="card-foot">
                            <button style="margin-left:30px;" v-on:click="Zakazi(tempHospital.id)" class="btn btn-primary">Zakazi</button>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</template>



<script>

import StarRating from 'vue-star-rating'
import dataService from '../services/dataService'
export default{
    components:{
        starrating:StarRating,
    },
    props:[
        'listaCentara',
        'terminTemp',
        
    ],
    data(){
        return{
            // listaCentara:[],
            currentSort : 'nazivEntiteta',
            currentSortDir : 'asc',
            inputFilter : '',
            terminTemp:{
                    pocetakTermina:'',
                    krajTermina:'',
            },
            userId:'',
            body:{
                id:'',
                userId:'',
                terminTemp:{
                    pocetakTermina:'',
                    krajTermina:'',
                }
            }, 
            messages:[],
            message:''

        }
    },
    methods:{
        Zakazi(id){
           // console.log(this.terminTemp);
           // console.log(this.userId)
            this.body.id=id;
            this.body.userId=this.userId;
            this.body.terminTemp=this.terminTemp;
            console.log(this.body)
            try{
            dataService.customRezervisi(this.body).then(response => {
                    console.log("stigao odgovor");
                    if(response.status == 200){
                        this.message= "Uspesna rezervacija";
                    
                    }else if(response.status == 226){
                        this.message = 'Vec ste rezervisali';
                    }else if(response.status == 208){
                        this.message = 'Niste popunili obavezni upitnik';
                    }else if(response.status == 207){
                        this.message = 'Vec ste donirali krv u preth. 6 meseci';
                    }else{
                        this.message = 'Neuspesna rezervacija.';
                    }
                    alert(this.message);
                });
            }catch(error){
                console.log("doslo je do greske: " + error);
                this.message = "<h4>Neuspesna rezervacija.</h4>"
                alert(this.message);
            }
        },
        tempSort(s){
            if (s === this.currentSort) {
                this.currentSortDir = this.currentSortDir === 'asc' ? 'desc' : 'asc';
            }
            this.currentSort = s;
        },
        filterByName(rst){
            if(this.inputFilter!= 0){
                return(rst.naziv.toLowerCase().indexOf(this.inputFilter.toLocaleLowerCase()) > -1 || rst.adresa.toLowerCase().indexOf(this.inputFilter.toLowerCase()) > -1);
            }
            return true;
        },
        sortiraj(tmpLista){
            let tempList = [];
            if(this.currentSort == 'nazivEntiteta'){
                if(this.currentSortDir == 'asc'){
                    tempList = tmpLista.sort((a, b) => (a.naziv > b.naziv) ? 1 : -1);
                }
                else{
                    tempList = tmpLista.sort((a, b) => (a.naziv < b.naziv) ? 1 : -1)
                }
            }
            if(this.currentSort == 'lokacijaEntiteta'){
                if(this.currentSortDir == 'asc'){
                    tempList = tmpLista.sort((a, b) => (a.adresa > b.adresa) ? 1 : -1);
                }
                else{
                    tempList =  tmpLista.sort((a, b) => (a.adresa < b.adresa) ? 1 : -1)
                }
            }
            if(this.currentSort == 'ocenaEntiteta'){
                if(this.currentSortDir == 'asc'){
                    tempList = tmpLista.sort((a, b) => (a.ocena > b.ocena) ? 1 : -1);
                }
                else{
                    tempList = tmpLista.sort((a, b) => (a.ocena < b.ocena) ? 1 : -1);
                }
            }
            if(this.currentSort == 'razdaljinaEntiteta'){
                if(this.currentSortDir == 'asc'){
                    tempList = tmpLista.sort((a, b) => (a.razdaljina > b.razdaljina) ? 1 : -1);
                }
                else{
                    tempList = tmpLista.sort((a, b) => (a.razdaljina < b.razdaljina) ? 1 : -1);
                }
            }
            return tempList;
        }
    },
    created(){
        console.log("IMPORT")
            if(JSON.parse(localStorage.getItem('token')) == null){
                this.$router.push(`/login`);
            }
            else{
                
                 let tempUsername = localStorage.getItem('parsToken').split(",")[0].split(':')[1];
                 tempUsername = tempUsername.slice(1, tempUsername.length - 1).trim();
                 let tempId = localStorage.getItem('parsToken').split(",")[3].split(':')[1];
                 tempId = tempId.trim();
                 this.userId = tempId;
                 console.log("ID KORISNIKA: " + tempId)
            }
    },
    computed:{
        sortEntities(){
            let tempLista = this.listaCentara.filter(this.filterByName);
            let tempLista2 = this.sortiraj(tempLista);
            return tempLista2;
        },
    }
}
</script>


<style scoped>
.filter-button{
    color: #0275d8;
    border: 2px solid #0275d8;
    background-color: white;
    font-weight: 500;
    width:100px;
    font-size: 15px;
    padding:10px;
    margin:10px;
    cursor: pointer;
    transition-duration: 0.4s;
}
.filter-button:hover{
    background-color: #0275d8;
    color: white;
}
</style>